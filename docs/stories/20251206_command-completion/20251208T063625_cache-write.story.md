## Story Log

### Goal
Implement automatic cache writing when commands reference or display items.

### Why
Shell completion needs a pre-computed cache of recently used aliases and context tags. By automatically capturing these during normal command usage (mm ls, mm note, etc.), users get working completion without any extra effort. IDs are not cached for completion since they are long UUIDs not meant for manual typing; aliases serve this purpose.

### User Story
**As a** mm user, **I want** commands to automatically record used items to a cache file, **so that** shell completion can suggest recently accessed aliases and tags.

### Acceptance Criteria

#### 1. Cache File Creation
- [x] **Given** a workspace exists, **When** you run any command that creates/displays items, **Then** `.index/completion_aliases.txt` and/or `.index/completion_context_tags.txt` are created if they don't exist
- [x] **Given** no workspace is active, **When** you run a command, **Then** no cache files are created and no error occurs

#### 2. Cache Format (Plain Text)
- [x] **Given** a command creates an item, **When** you inspect the cache files, **Then** they contain plain text with one value per line
- [x] **Given** an item has an alias, **When** the item is cached, **Then** the alias value is appended to `completion_aliases.txt`
- [x] **Given** an item has a context tag, **When** the item is cached, **Then** the tag value is appended to `completion_context_tags.txt`
- [x] **Given** cache files exist, **When** you inspect them, **Then** newer entries appear toward the end of the file

#### 3. Cache Population from Arguments
- [x] **Given** you run `mm note "Hello" --context work`, **When** the command completes successfully, **Then** `completion_context_tags.txt` contains "work"
- [x] **Given** you run a command that fails, **When** the command exits with an error, **Then** the cache is not updated

#### 4. Cache Population from Results
- [x] **Given** you run `mm note "Hello"`, **When** the command successfully creates an item, **Then** `completion_aliases.txt` contains the new item's auto-generated alias
- [x] **Given** you run `mm ls`, **When** items are successfully displayed, **Then** the cache files contain entries for all displayed items' aliases and context tags

#### 5. Deduplication
- [x] **Given** you append N new entries, **When** the cache update occurs, **Then** the last N lines are checked and duplicates are skipped
- [x] **Given** a value already exists in the tail, **When** you try to append it again, **Then** it is not duplicated

#### 6. Auto-Truncation
- [x] **Given** a cache file exceeds 1000 lines, **When** new entries are appended, **Then** old entries are removed from the beginning to maintain max 1000 lines
- [x] **Given** truncation occurs, **When** inspecting the cache, **Then** the most recent 1000 entries are preserved

#### 7. Error Cases
- [x] **Given** the cache file is read-only, **When** a command tries to update the cache, **Then** the cache write fails silently without breaking the command
- [x] **Given** the `.index` directory doesn't exist, **When** a command updates the cache, **Then** the directory is created automatically

### Out of Scope
- Shell completion script generation (Subsquent story)
- Shell script integration for reading the cache (Subsquent story)
- Advanced compaction strategies (e.g., detecting stale aliases)

---

### Completed Work Summary

**Implementation Complete**

Implemented a simplified cache infrastructure with TDD approach:

1. **Domain Model** (`src/domain/models/completion_cache_entry.ts`):
   - Type aliases for `AliasCompletionEntry` and `ContextTagCompletionEntry` (both are strings)
   - Excludes ID entries (UUIDs not meant for manual typing)
   - No timestamps - file order represents recency (newest at end)

2. **Cache Repository** (`src/infrastructure/completion_cache/cache_repository.ts`):
   - Two plain text files: `completion_aliases.txt` and `completion_context_tags.txt`
   - `readAliases()` / `readContextTags()`: Returns string arrays
   - `appendAliases()` / `appendContextTags()`: Appends with deduplication and truncation
   - Deduplication: Checks last N lines (N = number of new entries) before appending
   - Auto-truncation: Removes from beginning when exceeding maxEntries (1000)

3. **Cache Manager** (`src/infrastructure/completion_cache/cache_manager.ts`):
   - Coordinates Repository for two separate caches
   - Simple delegation: `addAliases()`, `addContextTags()`, `getAliases()`, `getContextTags()`
   - No compaction logic needed (handled by repository on each append)

4. **Cache Extractor** (`src/infrastructure/completion_cache/cache_extractor.ts`):
   - `extractFromItem()`: Extracts alias and context tag from single item
   - `extractFromItems()`: Extracts from multiple items (for `mm ls`)
   - `extractFromArgs()`: Extracts context tag from command arguments
   - Returns `{ aliases: string[], contextTags: string[] }`

5. **Cache Update Service** (`src/infrastructure/completion_cache/cache_update_service.ts`):
   - High-level API for commands: `updateFromArgs()`, `updateFromItem()`, `updateFromItems()`
   - Silently handles errors to ensure cache failures don't break commands
   - Integrated into dependencies and available to all commands

6. **Command Integration**:
   - `note.ts`: Caches context from args + alias/tag from created item
   - `edit.ts`: Caches context from args + alias/tag from updated item
   - `list.ts`: Caches all displayed items (aliases and context tags)
   - `close.ts`: Caches closed items

**Test Coverage**: 28 cache unit tests + 421 total unit tests passing

**Design Decisions**:
- **Two files**: Separate `completion_aliases.txt` and `completion_context_tags.txt` for future extensibility (regular tags vs context tags)
- **Plain text**: Simpler than JSONL, easier shell script integration
- **No timestamps**: File order (newest at end) eliminates need for `last_seen` field
- **Tail-only dedup**: More efficient than full-file scan, adequate for typical usage
- **Per-append truncation**: Simpler than separate compaction phase

### Acceptance Checks

**Status: Ready for Product Owner Review**

Developer verification completed:
- ✅ All 28 cache unit tests passing
- ✅ All 421 total unit tests passing
- ✅ Manual testing:
  - `mm note --context work` creates and populates `completion_context_tags.txt`
  - `mm ls` populates both `completion_aliases.txt` and `completion_context_tags.txt`
  - Duplicate values are not re-added
  - Cache survives read-only filesystem errors (silent failure)
  - Files are created in correct location (`.index/` directory)

**Awaiting product owner acceptance testing before marking this user story as complete.**

### Follow-ups / Open Risks

#### Addressed
- Originally planned JSONL format → Simplified to plain text
- Originally planned atomic writes → Not needed for plain text append
- Originally planned separate compaction phase → Integrated into append operation
- Originally planned canonical_key field → Not needed (values are case-sensitive)
- Originally planned last_seen timestamps → File order is sufficient

#### Remaining
- Shell completion script implementation (Story 2)
- Testing with large datasets (1000+ entries)
- Performance testing with concurrent writes
