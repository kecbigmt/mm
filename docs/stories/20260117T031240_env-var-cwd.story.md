## Story Log

### Goal
Store the current working directory (cwd) in an environment variable instead of `.state.json`, so it resets on each shell session.

### Why
Currently, the cwd is persisted in `.state.json`, which means if a user changes their working directory and forgets where they are, unintended operations may occur in an unexpected location. By storing cwd in an environment variable (`MM_CWD`), each new shell session starts fresh with today's date as the default placement, reducing the risk of accidental misoperations.

### User Story
**As a CLI user, I want the working directory to reset to today's date when I start a new shell session, so that I don't accidentally perform operations in an unintended location.**

### Acceptance Criteria

#### 1. Environment Variable Storage
- [ ] **Given** no `MM_CWD` environment variable is set, **When** you run `mm pwd`, **Then** it displays today's date (in the workspace's configured timezone) as the current placement
- [ ] **Given** you run `mm cd 2025-12-25`, **When** you run `mm pwd` in the same shell session, **Then** it displays `2025-12-25` (the change is session-scoped)
- [ ] **Given** you run `mm cd 2025-12-25` and then start a new shell session, **When** you run `mm pwd` in the new session, **Then** it displays today's date (not `2025-12-25`)

#### 2. CLI Sets Environment Variable
- [ ] **Given** you run `eval "$(mm cd 2025-12-25)"`, **When** you check `echo $MM_CWD`, **Then** it shows the placement string `2025-12-25`
- [ ] **Given** you run `eval "$(mm cd permanent)"`, **When** you check `echo $MM_CWD`, **Then** it shows `permanent`
- [ ] **Given** you run `eval "$(mm cd /1)"` from a date placement, **When** you check `echo $MM_CWD`, **Then** it shows the date with section (e.g., `2026-01-17/1`)

#### 3. Default Value
- [ ] **Given** `MM_CWD` is not set or empty, **When** any command reads cwd, **Then** it defaults to today's date in the workspace's timezone (no sections)
- [ ] **Given** `MM_CWD` is set to an invalid format, **When** any command reads cwd, **Then** it falls back to today's date and outputs a warning

#### 4. Backward Compatibility
- [ ] **Given** `.state.json` contains a `default_cwd` field, **When** `MM_CWD` is not set, **Then** the cwd defaults to today (not the persisted value) - the persisted cwd is no longer used

### Verification Approach
Direct CLI command execution in a shell environment. Verify by:
1. Running `mm pwd` without `MM_CWD` set â†’ shows today
2. Running `eval "$(mm cd <target>)"` and checking `$MM_CWD`
3. Opening new shell sessions to confirm reset behavior

### Out of Scope
- Migration of existing `.state.json` cwd values (they will simply be ignored)
- Removing `default_cwd` from `.state.json` schema (can be cleaned up later)
- Fish shell or other non-POSIX shell support (focus on bash/zsh for now)

---

### Implementation (Red-Green)

**Status: Complete - Ready for Verification**

**Implemented:**
- Environment variable storage: `MM_CWD` environment variable for cwd persistence
- Default cwd: Today's date (workspace timezone) when `MM_CWD` is unset/empty
- cd command: Outputs `export MM_CWD="<placement>"` for shell eval
- Invalid MM_CWD handling: Falls back to today with warning message
- All commands updated to use new `CwdResolutionService` API

**Decisions:**
- cd outputs shell export statement: Users run `eval "$(mm cd <path>)"` to set cwd
- pwd/other commands read from `MM_CWD`: Direct environment variable access
- Removed dependency on `StateRepository` for cwd: Simplifies the cwd mechanism
- `validatePlacement` replaces `setCwd`: No persistence, only validation

**Tests:**
- `src/domain/services/cwd_resolution_service_test.ts`: 13 unit tests for getCwd/validatePlacement
- E2E tests updated: All scenarios pass (except CI-environment-dependent shell completion tests)

**Technical debt:**
- `StateRepository` still has `saveCwd`/`loadCwd` methods: Can be removed in follow-up
- `default_cwd` field in `.state.json`: No longer used, can be deprecated

**Files Changed:**
- `src/domain/services/cwd_resolution_service.ts`: New API with `getCwd` (env var) and `validatePlacement`
- `src/presentation/cli/commands/cd.ts`: Outputs `export MM_CWD=...`
- `src/presentation/cli/commands/pwd.ts`: Uses new getCwd API
- `src/presentation/cli/commands/list.ts`: Uses new getCwd API
- `src/presentation/cli/commands/note.ts`: Uses new getCwd API
- `src/presentation/cli/commands/task.ts`: Uses new getCwd API
- `src/presentation/cli/commands/event.ts`: Uses new getCwd API
- `src/presentation/cli/commands/move.ts`: Uses new getCwd API
- `src/presentation/cli/commands/snooze.ts`: Uses new getCwd API
- `src/presentation/cli/commands/doctor/rebalance_rank.ts`: Uses new getCwd API
- `tests/e2e/helpers.ts`: Added `runCd` helper and `mmCwd` option
- Multiple E2E test files: Updated to use new cd/cwd pattern

**Next:** Product Owner Acceptance

---

### Completed Work Summary

Implemented environment variable-based cwd storage:
1. `MM_CWD` environment variable stores current working directory
2. `mm cd <path>` outputs `export MM_CWD="<placement>"` for shell eval
3. Default cwd is today's date in workspace timezone
4. Invalid `MM_CWD` values fall back to today with warning
5. All commands updated to use new `CwdResolutionService.getCwd()` API

### Acceptance Checks

**Status: Pending Product Owner Review**

Developer verification completed:
- [x] `mm pwd` without `MM_CWD` set shows today's date
- [x] `eval "$(mm cd 2025-12-25)"` sets `MM_CWD=2025-12-25`
- [x] New shell session starts with today's date (no `MM_CWD` inherited)
- [x] Invalid `MM_CWD` values show warning and fall back to today
- [x] All unit tests pass (13 tests)
- [x] All E2E tests pass (except CI-environment-dependent shell completion tests)

**Awaiting product owner acceptance testing before marking this user story as complete.**

### Follow-ups / Open Risks

#### Addressed
- cd command now outputs shell-evaluable export statement
- All commands read from `MM_CWD` environment variable
- Default is today's date in workspace timezone

#### Remaining
- Users upgrading from the previous version will need to update their shell config to use `eval "$(mm cd ...)"` pattern
- The `cd` command output format changes from silent operation to shell-evaluable output
- `StateRepository.saveCwd`/`loadCwd` methods can be removed in follow-up cleanup
