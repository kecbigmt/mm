## Story Log

### Goal
Implement `mm sync init` to initialize a Git repository and configure synchronization settings in `workspace.json`.

### Why
To enable the GitHub Sync epic, we first need a command that sets up the local Git repository, configures the remote connection, and persists the user's preference for synchronization in the workspace configuration.

### User Story
**As a** mm user, **I want** to initialize my workspace with `mm sync init <repo-url>`, **so that** I can start syncing my knowledge graph to a remote Git repository.

### Acceptance Criteria

#### 1. Command Execution & Repository Initialization
- [ ] **Given** a workspace that is not a git repo, **When** I run `mm sync init https://github.com/user/repo.git`, **Then** a git repository is initialized in the workspace root.
- [ ] **Given** a new git repo, **When** initialized, **Then** the remote `origin` is set to the provided URL.
- [ ] **Given** an existing git repo with the *same* remote URL, **When** I run `mm sync init`, **Then** it succeeds idempotently.
- [ ] **Given** an existing git repo with a *different* remote URL, **When** I run `mm sync init`, **Then** it fails with an error to prevent accidental overwrite.
- [ ] **Given** an existing git repo with a *different* remote URL, **When** I run `mm sync init --force`, **Then** the remote URL is updated to the new one.
- [ ] **Given** `mm sync init` is run, **Then** `.gitignore` is created (or updated) to ignore `.state.json`, `.index/`, `.tmp/`, `.DS_Store`, and `*.swp`.
- [ ] **Given** `mm sync init` is run, **Then** an initial commit is created with message "mm: initialize workspace git repository".

#### 2. Configuration Persistence
- [ ] **Given** `mm sync init` completes, **When** I inspect `workspace.json`, **Then** it has a `git` object with `enabled: true`, `remote: <url>`, `branch: "main"`, and `sync_mode: "auto-commit"`.
- [ ] **Given** valid input, **When** I run `mm sync init <url> --branch develop`, **Then** `workspace.json` records `branch: "develop"`.

#### 3. Error Cases
- [ ] **Given** an invalid Git URL format, **When** I run `mm sync init <invalid-url>`, **Then** it returns an error and does not modify the workspace.
- [ ] **Given** an invalid branch name, **When** I run `mm sync init`, **Then** it returns a specific validation error "Invalid branch name: <branch>".
- [ ] **Given** Git is not installed or a system git error occurs (e.g. permission check), **When** command runs, **Then** it fails gracefully with the original Git error message (not masked as a validation error).

### Out of Scope
- Implementation of `mm sync pull` or `mm sync push` (separate stories).
- Handling authentication (relies on user's system git auth).
- `mm sync status`.

---

### Completed Work Summary
Implemented `mm sync init` functionality:
- Updated `WorkspaceSettings` to include `git` configuration (enabled, remote, branch, syncMode).
- Implemented `VersionControlService` interface and `GitClient` implementation.
  - Renamed `checkBranchFormat` to `validateBranchName` for clarity.
  - Implemented robust `setRemote` logic:
    - Checks for existing remotes using `git remote` listing.
    - Prevents silent overwrite of conflicting remote URLs (fails unless `--force` is used).
    - Uses `git remote set-url` for updates and `git remote add` for new remotes.
- Implemented `SyncInitWorkflow`:
  - Initializes git repo.
  - Validates branch name (distinguishing between validation errors and method-level git errors).
  - Sets remote `origin` (with force flag support).
  - Updates `workspace.json`.
  - Creates/updates `.gitignore`.
  - Stages and commits initial files.
- Added CLI command `mm sync init` in `src/presentation/cli/commands/sync.ts` with `--force` flag.
- Wiring & Verification:
  - Wired `VersionControlService` into `CliDependencies`.
  - Registered `sync` command in `src/main.ts`.
  - Comprehensive testing of success, conflict, force, and error scenarios.

### Acceptance Checks

**Status: Ready for Acceptance Testing**

Developer verification completed:
- [x] Verified `git init` and remote configuration manually (via tests + manual run).
- [x] Verified `workspace.json` updates (via tests + manual run).
- [x] Verified `.gitignore` generation (via tests + manual run).
- [x] Verified initial commit creation (via tests + manual run).
- [x] Verified `--force` flag behavior and conflict protection.
- [x] Verified Git error propagation (e.g. absent git).

**Awaiting product owner acceptance testing before marking this user story as complete.**

### Follow-ups / Open Risks

#### Addressed
- Refactored `GitService` to `VersionControlService`.
- CLI command wiring completed.
- Robust handling of existing Git repositories and remote conflicts.

#### Remaining
- Global options handling for custom workspace paths seems to rely on `deps` loading logic, verified to work via `deps.root`.
