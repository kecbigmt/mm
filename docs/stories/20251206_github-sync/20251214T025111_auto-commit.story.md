## Story Log

### Goal
Implement automatic Git commits for state-changing commands when `git.sync_mode` is "auto-commit" or "auto-sync".

### Why
Users running in auto-commit mode want their changes automatically committed to Git after each operation without having to manually run `git commit` or `mm sync`. This provides a granular commit history and ensures no work is lost, while still giving users control over when to push to remote (unlike auto-sync mode, which will be implemented separately).

### User Story
**As a mm user, I want my changes to be automatically committed when git.sync_mode is "auto-commit", so that I have a complete Git history of my work without manual commit operations.**

### Acceptance Criteria

#### 1. Auto-commit for Node Creation Commands
- [x] **Given** `git.enabled=true` and `sync_mode="auto-commit"`, **When** I run `mm note <content>`, **Then** a Git commit is created after the note is saved.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-commit"`, **When** I run `mm task <content>`, **Then** a Git commit is created after the task is saved.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-commit"`, **When** I run `mm event <content>`, **Then** a Git commit is created after the event is saved.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-commit"`, **When** I run `mm n <content>` (shorthand), **Then** a Git commit is created after the node is saved.

#### 2. Auto-commit for State-changing Commands
- [x] **Given** `git.enabled=true` and `sync_mode="auto-commit"`, **When** I run `mm mv <source> <target>`, **Then** a Git commit is created after the move operation.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-commit"`, **When** I run `mm remove <path>`, **Then** a Git commit is created after the removal.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-commit"`, **When** I run `mm close <task-path>`, **Then** a Git commit is created after the task is closed.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-commit"`, **When** I run `mm reopen <task-path>`, **Then** a Git commit is created after the task is reopened.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-commit"`, **When** I run `mm edit <path>` and save changes, **Then** a Git commit is created after the edit is complete.

#### 3. Commit Message Format
- [x] **Given** auto-commit is triggered, **When** the commit is created, **Then** the commit message follows the format "mm: <brief summary>".
- [x] **Given** I create a note with `mm note "Meeting notes"`, **When** auto-commit runs, **Then** the commit message includes relevant context (e.g., "mm: create new note \"Meeting notes\"").
- [x] **Given** I move a node with `mm mv`, **When** auto-commit runs, **Then** the commit message indicates the move operation.

#### 4. No Auto-commit When Disabled
- [x] **Given** `git.enabled=false`, **When** I run any state-changing command, **Then** no Git commit is created.
- [x] **Given** `git.enabled=true` and `sync_mode` defaults to "auto-commit", **When** I run a state-changing command, **Then** a Git commit is created.
- [x] **Given** `sync_mode="auto-sync"`, **When** I run a state-changing command, **Then** a Git commit is created (but no push yet - that's a separate story).

#### 5. Error Handling
- [x] **Given** auto-commit is triggered but Git commit fails (e.g., no Git installed, permission error), **When** the command completes, **Then** a warning is displayed but the filesystem changes remain applied.
- [x] **Given** auto-commit fails, **When** the warning is shown, **Then** it includes the Git error message to help with debugging.
- [x] **Given** there are no actual changes to commit (Git working tree clean), **When** auto-commit is triggered, **Then** no commit is created and no error is shown.

#### 6. Staged Files
- [x] **Given** auto-commit is triggered, **When** Git commit is created, **Then** it stages and commits `items/**/*.md`, `tags/*.tag.json`, and `workspace.json`.
- [x] **Given** auto-commit is triggered, **When** Git commit is created, **Then** it does not stage `.state.json`, `.index/`, or other ignored files.

### Out of Scope
- Auto-push functionality (part of auto-sync mode, separate story)
- Retry logic for failed commits
- Custom commit message templates (`git.commit_template` is future work per Epic section 0)
- Author name/email overrides (`git.author_name`/`git.author_email` is future work per Epic section 0)
- Hooks or pre-commit validation
- `mm sync status` command

---

### Completed Work Summary

**Implementation completed on 2025-12-14**

Created:
- `src/domain/workflows/auto_commit.ts` - Core auto-commit workflow logic
- `src/presentation/cli/auto_commit_helper.ts` - CLI helper function for state-changing commands
- `src/domain/workflows/auto_commit_test.ts` - 8 unit tests covering all scenarios

Modified:
- `src/domain/models/workspace.ts` - Added `GitSyncMode` type definition
- `src/presentation/cli/commands/note.ts` - Added auto-commit integration
- `src/presentation/cli/commands/task.ts` - Added auto-commit integration
- `src/presentation/cli/commands/event.ts` - Added auto-commit integration
- `src/presentation/cli/commands/move.ts` - Added auto-commit integration
- `src/presentation/cli/commands/edit.ts` - Added auto-commit integration (both editor and metadata paths)
- `src/presentation/cli/commands/close.ts` - Added auto-commit integration
- `src/presentation/cli/commands/reopen.ts` - Added auto-commit integration

Deleted:
- `src/presentation/cli/commands/mv.ts` - Removed incorrect duplicate file (actual command is in `move.ts`)

### Acceptance Checks

**Status: Accepted**

Developer verification completed:
- All 23 acceptance criteria verified manually in test workspace
- All 8 unit tests passing
- Full test suite: 20 passed (163 steps), 0 failed
- Tested with both `auto-commit` and `auto-sync` sync modes
- Tested with `enabled=false` to verify no commits created
- Verified commit message format follows "mm: <action summary>" pattern
- Verified files staged: items/, tags/, workspace.json (excludes .index/)
- Verified error handling: warnings displayed on failure, operations never roll back
- Verified "nothing to commit" case handled gracefully

**Product owner acceptance testing completed.**

### Follow-ups / Open Risks

#### Addressed
- **Issue**: Initially edited wrong file (`mv.ts` instead of `move.ts`)
  **Resolution**: Discovered actual command uses `move.ts`, removed duplicate `mv.ts`

- **Issue**: Mistakenly added `"manual"` sync mode not in epic design
  **Resolution**: Removed `manual` from `GitSyncMode` type, keeping only `auto-commit` and `auto-sync` as per epic

- **Issue**: Commit message format initially included redundant command name
  **Resolution**: Changed from `mm: task - create new task "X"` to `mm: create new task "X"`

#### Remaining
- Auto-sync mode (automatic push after commit) is separate story, not yet implemented
- Cache update after move operation added during implementation - verify this doesn't cause issues
