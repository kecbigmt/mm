## Story Log

### Goal
Implement auto-sync mode to automatically push commits to remote repository after state-changing commands.

### Why
Users running in `auto-commit` mode currently have their changes automatically committed locally, but they must manually run `mm sync` to push to remote. Implementing `auto-sync` mode enables continuous synchronization across devices by automatically pushing commits after each state-changing operation, completing the GitHub Sync epic's automation goals.

### User Story
**As a mm user, I want `sync_mode="auto-sync"` to automatically push my commits to GitHub after state-changing commands, so that my workspace is continuously synchronized across devices without manual sync operations.**

### Acceptance Criteria

#### 1. Auto-sync on Node Creation Commands
- [x] **Given** `git.enabled=true` and `sync_mode="auto-sync"`, **When** I run `mm note <content>`, **Then** a Git commit is created and automatically pushed to the remote repository.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-sync"`, **When** I run `mm task <content>`, **Then** a Git commit is created and automatically pushed to the remote repository.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-sync"`, **When** I run `mm event <content>`, **Then** a Git commit is created and automatically pushed to the remote repository.

#### 2. Auto-sync on State-changing Commands
- [x] **Given** `git.enabled=true` and `sync_mode="auto-sync"`, **When** I run `mm mv <source> <target>`, **Then** a Git commit is created and automatically pushed to the remote repository.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-sync"`, **When** I run `mm remove <path>`, **Then** a Git commit is created and automatically pushed to the remote repository.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-sync"`, **When** I run `mm close <task-path>`, **Then** a Git commit is created and automatically pushed to the remote repository.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-sync"`, **When** I run `mm reopen <task-path>`, **Then** a Git commit is created and automatically pushed to the remote repository.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-sync"`, **When** I run `mm snooze <task-path>`, **Then** a Git commit is created and automatically pushed to the remote repository.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-sync"`, **When** I run `mm edit <path>` and save changes, **Then** a Git commit is created and automatically pushed to the remote repository.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-sync"`, **When** I run `mm close <task1> <task2> <task3>` (multiple items), **Then** a single Git commit is created for all successfully processed items and automatically pushed to the remote repository.

#### 3. Commit-Pull-Push Synchronization
- [x] **Given** `sync_mode="auto-sync"`, **When** auto-sync runs, **Then** it creates a commit first (ensuring offline resilience).
- [x] **Given** commit is created and remote has new commits, **When** auto-sync continues, **Then** it pulls remote changes with rebase (`git pull --rebase`).
- [x] **Given** rebase succeeds, **When** auto-sync continues, **Then** it pushes local commits and changes are synchronized.
- [x] **Given** rebase fails (conflict), **When** auto-sync completes, **Then** a warning message is displayed: "Warning: Auto-sync pull failed: <error message>."
- [x] **Given** auto-sync fails, **When** the warning is shown, **Then** the filesystem changes and commit remain applied (no rollback).

#### 4. No Auto-sync When Disabled
- [x] **Given** `git.enabled=false`, **When** I run any state-changing command, **Then** no Git commit or push is performed.
- [x] **Given** `git.enabled=true` and `sync_mode="auto-commit"`, **When** I run a state-changing command, **Then** a Git commit is created but no push is performed (existing behavior).

#### 5. Error Handling
- [x] **Given** auto-sync is triggered but pull/push fails due to network error, **When** the command completes, **Then** a warning is displayed with the Git error message but the filesystem changes and commit remain applied.
- [x] **Given** auto-sync is triggered but push fails due to authentication error, **When** the command completes, **Then** a warning is displayed with the Git error message but the filesystem changes and commit remain applied.
- [x] **Given** there are no actual changes to commit (Git working tree clean), **When** auto-sync is triggered, **Then** no commit or push is performed and no error is shown.

#### 6. Output Messages
- [x] **Given** auto-sync performs pull and push successfully, **When** the operation completes, **Then** no output is displayed (silent on success).

### Out of Scope
- Automatic conflict resolution (manual resolution required)
- Interactive rebase options
- Custom commit message templates (`git.commit_template` is future work)
- Author name/email overrides (`git.author_name`/`git.author_email` is future work)
- Progress indicators or spinners during network operations

---

### Completed Work Summary

**Implementation completed on 2025-12-14**

**Design Evolution:**
- Initial design: pull→commit→push (fast-forward only)
- Revised design: commit→pull(rebase)→push (for offline resilience and multi-device support)

Modified:
- `src/domain/workflows/auto_commit.ts` - Implemented commit→pull(rebase)→push pattern
  - Added `pushed?: boolean` to `AutoCommitResult` type
  - Commits created first for offline resilience
  - Pull with rebase integrates remote changes
  - Push completes synchronization
  - Comprehensive error handling for all failure scenarios
- `src/infrastructure/git/git_client.ts` - Changed pull to use rebase by default
  - `git pull --ff-only` → `git pull --rebase`
- `src/domain/workflows/auto_commit_test.ts` - Updated unit tests for rebase-based workflow
  - 12 unit tests covering all auto-sync scenarios
  - Tests verify commit→pull→push ordering
  - Tests verify offline resilience (commit always created)
  - Tests verify rebase conflict handling

Test Results:
- 12 unit tests passing for AutoCommitWorkflow
- All tests updated for rebase-based design
- Offline resilience verified
- Rebase conflict handling verified
- 14 E2E tests passing for GitHub sync integration
  - Scenario 21: sync init (5 tests)
  - Scenario 22: auto-commit mode (4 tests)
  - Scenario 23: auto-sync mode (2 tests)
  - Scenario 24: manual sync commands (3 tests)

### Acceptance Checks

**Status: ✅ Accepted by Product Owner (2025-12-15)**

Product Owner acceptance testing completed:
- ✅ AC1: Auto-sync on node creation commands (note/task/event) verified
- ✅ AC2: Auto-sync on state-changing commands (mv/remove/close/reopen/snooze/edit) verified
- ✅ AC3: Commit→pull(rebase)→push synchronization pattern verified
- ✅ AC4: No auto-sync when disabled verified
- ✅ AC5: Error handling verified (network errors, auth errors, no changes)
- ✅ AC6: Output messages verified (silent on success)

Developer verification completed:
- ✅ All 12 unit tests passing for AutoCommitWorkflow
- ✅ All 14 E2E tests passing for GitHub sync integration
- ✅ Commit→pull(rebase)→push pattern implemented according to revised Epic design
- ✅ Offline resilience verified (commits always created first)
- ✅ Rebase-based synchronization handles diverging branches gracefully
- ✅ Error handling for all failure scenarios verified
- ✅ Output messages verified: silent on success, warnings on failure
- ✅ Integration with all state-changing commands (note/task/event/mv/remove/close/reopen/snooze/edit)
- ✅ E2E tests verify actual Git operations (init, commit, pull, push)
- ✅ Code compiles successfully
- ✅ No regressions in domain workflow tests (87 tests passing)
- ✅ Domain/Presentation layer separation improved (error types vs messages)

Design benefits:
- Better multi-device support (rebase handles diverging branches)
- Offline resilience (commits created even when offline)
- Fewer conflicts (UUID-based file structure)
- Standard Git rebase workflow
- Clear separation of concerns (domain returns error types, presentation formats messages)

### Follow-ups / Open Risks

#### Remaining
- Index is not automatically rebuilt after `sync pull` - manual `mm doctor --rebuild-index` required after pulling remote changes
- Rebase conflict resolution may leave index in stale state - no automatic detection or warning after manual conflict resolution
- Item commits may include workspace.json changes (auto-commit stages both items and workspace.json) - could separate commit generation for configuration vs content changes
- No CLI command for changing sync configuration (sync_mode, remote, branch) - currently requires manual workspace.json editing
- No `mm sync status` command - users must use `git status` directly to check sync state
- Git authentication setup (SSH keys, GitHub PAT) is user's responsibility - no guidance or setup assistance provided by mm
- workspace.json schema ties to Git specifically (`git.enabled`, `git.sync_mode`) - should refactor to VCS-agnostic structure for future extensibility to other VCS. Proposed schema: `{ "sync": { "vcs": "git", "enabled": true, "sync_mode": "auto-commit", "git": { "remote": "...", "branch": "..." } } }` to allow VCS abstraction while keeping VCS-specific config nested
