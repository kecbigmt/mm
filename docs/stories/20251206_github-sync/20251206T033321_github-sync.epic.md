# mm GitHub Sync – DESIGN

Status: In Progress
Target version: mm v1.x

---

## 0. Scope & Non-Scope

### In Scope (initial release)

* Workspace directory `~/.mm/<workspace>/` is treated as **one Git repository**.
* Git sync is configured via `workspace.json.sync`.
* `sync.enabled: true/false` controls whether mm interacts with Git at all.
* Supported **sync modes**:
  * `"auto-commit"`
  * `"auto-sync"`
  * `"lazy-sync"`
* Implementation of `mm sync init`:
  * Initialize a Git repository if needed.
  * Configure remote `origin`.
  * Optionally set branch.
  * Auto-create `.gitignore`.
* Auto-enable `sync.enabled = true`.
* Automatic commit and automatic push according to sync mode.
* `mm sync pull`, `mm sync push`, `mm sync` as core sync commands.

### Out of Scope (future work)

These features are explicitly outside of the initial release:

* `mm sync status`
* `git.commit_template`
* `git.author_name` / `git.author_email` overrides
* GitHub API integration (repo creation, PRs, auth workflows)
* Support for multiple remotes
* Interactive rebase options
* Automatic conflict resolution (manual resolution is required)

---

## 1. Motivation & Goals

`mm` is built around plain text, Git-friendly diff structure, and deterministic ordering.
GitHub sync enables:

* Cross-device synchronization
* Backup strategy using standard Git tooling
* Collaboration in advanced use cases (optional)

Design goals:

1. **Compatibility with standard Git workflows**  
   mm must never prevent the user from using raw Git.

2. **Configurable automation level**
   Users choose:
* No Git automation (`enabled=false`)
* Automatic local commits (`auto-commit`)
* Automatic GitHub synchronization (`auto-sync`)

3. **Robustness**
* Rebase-based synchronization (`git pull --rebase`)
* Offline resilience (commits always created locally)
* Conflict resolution via standard Git workflow
* Recovery via `mm doctor --rebuild-index`

---

## 2. Terminology

* **Workspace** — `~/.mm/<workspace>/` directory (also Git repo root)
* **Workspace config** — `workspace.json`
* **Git enabled** — `workspace.json.sync.enabled == true`
* **Sync mode** — automation level when Git is enabled

---

## 3. Workspace Configuration Schema

### 3.1 JSON Structure

```jsonc
{
  "timezone": "Asia/Tokyo",
  "sync": {
    "vcs": "git",
    "enabled": false,
    "mode": "auto-commit",
    "git": {
      "remote": null
    },
    "lazy": {
      "commits": 10,
      "minutes": 10
    }
  }
}
```

### 3.2 Field Semantics

* `vcs: "git"`
  VCS type identifier. Currently only "git" is supported.

* `enabled: boolean`
  * `false`:
    mm never calls Git; all `mm sync ...` commands error out.
  * `true`:
    Git sync active, controlled by `mode`.

* `mode: "auto-commit" | "auto-sync" | "lazy-sync"`
  Requires `enabled=true` to take effect:

  * `"auto-commit"`
    mm automatically commits after state-changing commands, but does **not** push or pull.

  * `"auto-sync"`
    mm performs commit→pull(rebase)→push sequence after state-changing commands.
    Commit is always created first (ensuring offline resilience).
    Pull with rebase integrates remote changes by replaying local commits on top.
    If rebase fails (conflict), a warning is displayed with Git's error message.
    If push fails, a warning is displayed.

  * `"lazy-sync"`
    mm commits immediately like auto-commit, but syncs periodically based on thresholds.
    Sync is triggered when either threshold is met:
    - Commit count reaches `sync.lazy.commits` (default: 10)
    - Time since last sync exceeds `sync.lazy.minutes` (default: 10 minutes)
    When triggered, follows the same commit→pull(rebase)→push pattern as auto-sync.

* `git.remote: string | null`
  Git remote URL (typically the `origin` remote).
  Set by `mm sync init`.

* `git.branch?: string`
  Target branch for pull/push operations.
  If not set, `mm sync pull` resolves and persists the remote's default branch.

---

## 4. Git Tracking & .gitignore

### 4.1 What mm tracks

Tracked:

* `items/**/*.md`
* `workspace.json`
* `tags/*.tag.json`
* Any additional config files introduced later

Ignored:

* `.state.json`
* `.index/`
* Any transient caches

### 4.2 Auto-generated `.gitignore`

Created during `mm sync init` if missing:

```gitignore
# mm local state / caches
.state.json
.index/
.tmp/

# OS/editor noise
.DS_Store
*.swp```

If `.gitignore` already exists, mm appends mm-specific entries if absent.

---

## 5. mm sync init

### 5.1 Summary

Initializes Git sync for a workspace:

* Initializes Git repo (if absent)
* Configures remote `origin` to the provided URL
* Optionally sets branch (`--branch <name>`)
* Creates `.gitignore` if missing
* Writes Git config to `workspace.json.sync`
* Automatically enables: `sync.enabled = true`

### 5.2 CLI

```
mm sync init <remote-url> [--branch <branch-name>] [--force]
```

Examples:

```
mm sync init git@github.com:user/mm-workspace.git
mm sync init https://github.com/user/mm-notes.git --branch develop
mm sync init https://github.com/user/mm-notes.git --force
```

### 5.3 Behavior

1. Ensure workspace root exists.

2. Validate branch name format using Git:
   ```sh
   git check-ref-format --branch <branch>
   ```
   If invalid, fail with error message.

3. If not already a Git repo:
   ```sh
   git init
   ```

4. Set or update remote:

   * If `origin` doesn't exist: `git remote add origin <url>`
   * If `origin` exists with matching URL: Success (idempotent).
   * If `origin` exists with different URL:
     * Fail with error (default).
     * If `--force` provided: `git remote set-url origin <url>`

5. Write or update `workspace.json.sync`:

   ```jsonc
   {
       "vcs": "git",
       "enabled": true,
       "mode": "auto-commit",
       "git": {
           "remote": "<url>",
           "branch": "<branch (default: main)>"
       }
   }
   ```

6. Ensure `.gitignore` contains required entries.
7. Make an initial commit if necessary:

   ```sh
   git add items tags workspace.json .gitignore
   git commit -m "mm: initialize workspace git repository"
   ```

---

## 6. Sync Commands

### 6.1 mm sync pull

Pull with rebase.

```
mm sync pull
```

Behavior:

1. Check `sync.enabled`.
2. Check `sync.git.remote` and `sync.git.branch`.
3. Execute `git pull --rebase <remote> <branch>`.
4. If rebase fails (conflict), Git's error message is displayed.

Notes:

* After pull, user is advised (but not forced) to run:

  ```
  mm doctor --rebuild-index
  ```

  if edge files might be outdated.

---

### 6.2 mm sync push

Pushes local commits to remote.

```
mm sync push [--force]
```

Behavior:

1. Check `sync.enabled`.
2. Check `sync.git.remote` and `sync.git.branch` configuration.
3. Get current checked-out branch and validate it matches configured branch.
   * If mismatch: Error with message to checkout correct branch or update workspace.json.
   * This prevents accidentally pushing to wrong branch and losing changes.
4. Execute:

   ```sh
   git push origin <current-branch>
   # Or with --force:
   git push --force origin <current-branch>
   ```

5. Display git's output message (e.g., "Everything up-to-date", push summary, or error).
6. On failure, surface Git error message.

---

### 6.3 mm sync

Shortcut for full synchronization:

```
mm sync
```

Default flow:

1. `mm sync pull`
2. Optionally (config or flag): `mm doctor --rebuild-index`
3. `mm sync push`

This is especially useful in `auto-commit` mode.

---

## 7. Automatic Actions

### 7.1 State-changing commands

Commands such as:

* `mm n`, `mm note`, `mm task`, `mm event`
* `mm mv`, `mm remove`
* `mm close`, `mm reopen`
* `mm edit`

### 7.2 auto-commit Mode Behavior

After command success:

1. Check Git repository state.
2. If there are changes:

   ```sh
   git add items tags workspace.json
   git commit -m "mm: <auto summary>"
   ```

3. If commit fails:
   Show warning but do not roll back filesystem changes.

No push or pull is performed.

---

### 7.3 auto-sync Mode Behavior

The auto-sync workflow follows a **commit → pull(rebase) → push** pattern for optimal offline resilience:

1. **Create commit** (always happens first):

   ```sh
   git add items tags workspace.json
   git commit -m "mm: <auto summary>"
   ```

   This ensures local changes are saved even if network is unavailable.

2. **Pull with rebase**:

   ```sh
   git pull --rebase origin <branch>
   ```

   If pull fails (network error):
   ```
   Warning: Auto-sync pull failed: <error message>
   ```
   Commit remains; user can retry later with `mm sync`.

   If rebase fails (conflict):
   ```
   Warning: Auto-sync rebase failed: <Git error message>
   ```
   User must resolve conflict manually and run `mm sync`.

3. **Push to remote**:

   ```sh
   git push origin <branch>
   ```

   If push fails:
   ```
   Warning: Auto-sync push failed: <error message>
   ```

**Design rationale:**

By committing before pulling, auto-sync ensures:
- **Offline resilience**: Changes are saved locally even when offline
- **Graceful sync**: When online, rebase integrates remote changes by replaying local commits on top
- **Natural workflow**: Standard Git rebase workflow for multi-device usage

**Conflict handling:**

Due to mm's file structure (UUID-based filenames, independent files), conflicts are rare:
- Different notes/tasks → Different files → No conflict
- Same file edited on multiple devices → Rebase conflict (manual resolution required)

**Behavior notes:**

- Filesystem changes always remain applied, even if Git operations fail
- Commits are always created (unless "nothing to commit")
- Silent on success (no output messages)
- Warnings displayed on Git failures, but filesystem changes remain

---

## 8. Error Handling & Conflict Policy

### 8.1 Principles

* **Rebase-based sync** (no manual merges required in most cases)
* **Offline resilience** (commits created locally first)
* **mm operations never roll back file changes** even if Git fails
* User is always able to drop to raw Git to resolve issues

### 8.2 Conflict Cases

If `git pull --rebase` encounters conflicts, Git's error message is displayed.
User must resolve manually using standard Git commands:

```sh
# Fix conflicts in files
git add <resolved-files>
git rebase --continue
# Or abort: git rebase --abort
```

After resolving, user can run `mm sync` to complete push.

### 8.3 Broken Index Case

If `.index/graph` becomes stale due to Git operations:

```mm doctor --rebuild-index```

This regenerates all index files from Frontmatter, ensuring a healthy graph.

---

## 9. Implementation Notes

### 9.1 Git Command Execution

mm invokes Git via subprocess:

* `git status --porcelain`
* `git add`
* `git commit`
* `git fetch`, `git pull --ff-only`, `git push`

A small abstraction layer (`GitClient` implementing `VersionControlService`) is recommended.

### 9.2 Workspace Root

All Git commands must run in:

```~/.mm/<workspace>/```

Never inside subdirectories.

### 9.3 Safety Checks

* Remote URL validation (basic format check)
* Fail if `origin` exists with different URL (use `--force` to overwrite)
* Validate branch name using `git check-ref-format --branch`
* Branch mismatch detection: Before push, verify current checked-out branch matches configured branch to prevent accidental data loss

### 9.4 Auto-sync Implementation Details

**Commit→Pull(Rebase)→Push Pattern:**

The auto-sync workflow must execute operations in this specific order:

1. Create local commit with user's changes
2. Pull remote changes with rebase
3. Push to remote

This order is critical for offline resilience:
- Commits are created even when offline
- When online, rebase replays local commits on top of remote changes
- Push succeeds if no conflicts occurred during rebase

**Rebase vs Fast-Forward:**

Using `git pull --rebase` instead of `--ff-only` provides:
- **Better multi-device support**: Handles diverging branches gracefully
- **Offline resilience**: Local commits preserved even when network fails
- **Fewer conflicts**: mm's UUID-based file structure means different changes rarely conflict
- **Standard workflow**: Common Git pattern for distributed work

**Error Handling:**

- Commit failure: Skip pull and push, display warning based on error type
  - "nothing to commit" is treated as success (silent)
  - Other errors display warnings
- Pull/rebase failure: Display warning with Git error message
  - Network errors: Commit remains, user can retry with `mm sync`
  - Rebase conflicts: User must resolve manually
- Push failure: Display warning with Git error message

All warnings are non-fatal; filesystem changes and commits are never rolled back.

---

## 10. Summary

* Git sync is controlled by fields in `workspace.json.sync`:
  * `sync.enabled` — turns sync on/off
  * `sync.mode` — `"auto-commit"` or `"auto-sync"`
  * `sync.git.remote` and `sync.git.branch` — Git-specific settings
* `mm sync init` enables sync, configures repo, sets remote, generates `.gitignore`
* `auto-commit`: automatic commits only
* `auto-sync`: commit→pull(rebase)→push sequence
* Sync commands:
  * `mm sync pull` (with rebase)
  * `mm sync push`
  * `mm sync`
* Robustness ensured by:
  * Rebase-based sync handles diverging branches gracefully
  * Offline resilience (commits always created locally)
  * Rare conflicts due to UUID-based file structure
  * Manual conflict resolution when needed
  * Full `.index` rebuild via `mm doctor --rebuild-index`