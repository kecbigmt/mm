# mm GitHub Sync – DESIGN

Status: In Progress
Target version: mm v1.x

---

## 0. Scope & Non-Scope

### In Scope (initial release)

* Workspace directory `~/.mm/<workspace>/` is treated as **one Git repository**.
* Git sync is configured via `workspace.json.git`.
* `git.enabled: true/false` controls whether mm interacts with Git at all.
* Supported **sync modes**:
  * `"auto-commit"`
  * `"auto-sync"`
* Implementation of `mm sync init`:
  * Initialize a Git repository if needed.
  * Configure remote `origin`.
  * Optionally set branch.
  * Auto-create `.gitignore`.
* Auto-enable `git.enabled = true`.
* Automatic commit and automatic push according to sync mode.
* `mm sync pull`, `mm sync push`, `mm sync` as core sync commands.

### Out of Scope (future work)

These features are explicitly outside of the initial release:

* `mm sync status`
* `git.commit_template`
* `git.author_name` / `git.author_email` overrides
* GitHub API integration (repo creation, PRs, auth workflows)
* Non-fast-forward automatic merges (manual resolution is required)
* Support for multiple remotes

---

## 1. Motivation & Goals

`mm` is built around plain text, Git-friendly diff structure, and deterministic ordering.
GitHub sync enables:

* Cross-device synchronization
* Backup strategy using standard Git tooling
* Collaboration in advanced use cases (optional)

Design goals:

1. **Compatibility with standard Git workflows**  
   mm must never prevent the user from using raw Git.

2. **Configurable automation level**
   Users choose:
* No Git automation (`enabled=false`)
* Automatic local commits (`auto-commit`)
* Automatic GitHub synchronization (`auto-sync`)

3. **Robustness**
* No automatic merges
* Fast-forward only (`git pull --ff-only`)
* Recovery via `mm doctor --rebuild-index`

---

## 2. Terminology

* **Workspace** — `~/.mm/<workspace>/` directory (also Git repo root)
* **Workspace config** — `workspace.json`
* **Git enabled** — `workspace.json.git.enabled == true`
* **Sync mode** — automation level when Git is enabled

---

## 3. Workspace Configuration Schema

### 3.1 JSON Structure

```jsonc
{
  "timezone": "Asia/Tokyo",
  "git": {
    "enabled": false,
    "remote": null,
    "branch": "main",
    "sync_mode": "auto-commit"
  }
}
````

### 3.2 Field Semantics

* `enabled: boolean`
  * `false`:
    mm never calls Git; all `mm sync ...` commands error out.
  * `true`:
    Git sync active, controlled by `sync_mode`.

* `remote: string | null`
  Git remote URL (typically the `origin` remote).
  Set by `mm sync init`.

* `branch: string`
  Target branch for pull/push operations.
  Default `"main"`.

* `sync_mode: "auto-commit" | "auto-sync"`
  Requires `enabled=true` to take effect:

* `"auto-commit"`
    mm automatically commits after state-changing commands, but does **not** push or pull.

* `"auto-sync"`
    mm commits **and also pushes** after state-changing commands.
    If push is rejected, mm attempts a fast-forward pull and retries; if still rejected, errors.

---

## 4. Git Tracking & .gitignore

### 4.1 What mm tracks

Tracked:

* `items/**/*.md`
* `workspace.json`
* `tags/*.tag.json`
* Any additional config files introduced later

Ignored:

* `.state.json`
* `.index/`
* Any transient caches

### 4.2 Auto-generated `.gitignore`

Created during `mm sync init` if missing:

```gitignore
# mm local state / caches
.state.json
.index/
.tmp/

# OS/editor noise
.DS_Store
*.swp```

If `.gitignore` already exists, mm appends mm-specific entries if absent.

---

## 5. mm sync init

### 5.1 Summary

Initializes Git sync for a workspace:

* Initializes Git repo (if absent)
* Configures remote `origin` to the provided URL
* Optionally sets branch (`--branch <name>`)
* Creates `.gitignore` if missing
* Writes Git config to `workspace.json.git`
* Automatically enables: `git.enabled = true`

### 5.2 CLI

```
mm sync init <remote-url> [--branch <branch-name>] [--force]
```

Examples:

```
mm sync init git@github.com:user/mm-workspace.git
mm sync init https://github.com/user/mm-notes.git --branch develop
mm sync init https://github.com/user/mm-notes.git --force
```

### 5.3 Behavior

1. Ensure workspace root exists.

2. Validate branch name format using Git:
   ```sh
   git check-ref-format --branch <branch>
   ```
   If invalid, fail with error message.

3. If not already a Git repo:
   ```sh
   git init
   ```

4. Set or update remote:

   * If `origin` doesn't exist: `git remote add origin <url>`
   * If `origin` exists with matching URL: Success (idempotent).
   * If `origin` exists with different URL:
     * Fail with error (default).
     * If `--force` provided: `git remote set-url origin <url>`

5. Write or update `workspace.json.git`:

   ```jsonc
   {
       "enabled": true,
       "remote": "<url>",
       "branch": "<branch (default: main)>",
       "sync_mode": "auto-commit"
   }
   ```

6. Ensure `.gitignore` contains required entries.
7. Make an initial commit if necessary:

   ```sh
   git add items tags workspace.json .gitignore
   git commit -m "mm: initialize workspace git repository"
   ```

---

## 6. Sync Commands

### 6.1 mm sync pull

Fast-forward only pull.

```
mm sync pull
```

Behavior:

1. Check `git.enabled`.
2. Check `remote` and `branch`.
3. Execute:

   ```sh
   git fetch origin
   git pull --ff-only origin <branch>
   ```

4. If not fast-forward:

   ```
   [mm sync pull] Non-fast-forward update. 
   Resolve manually (e.g., 'git pull --rebase') and rerun.
   ```

Notes:

* After pull, user is advised (but not forced) to run:

  ```
  mm doctor --rebuild-index
  ```

  if edge files might be outdated.

---

### 6.2 mm sync push

Pushes local commits to remote.

```
mm sync push [--force]
```

Behavior:

1. Check `git.enabled`.
2. Check `remote` and `branch` configuration.
3. Get current checked-out branch and validate it matches configured branch.
   * If mismatch: Error with message to checkout correct branch or update workspace.json.
   * This prevents accidentally pushing to wrong branch and losing changes.
4. Execute:

   ```sh
   git push origin <current-branch>
   # Or with --force:
   git push --force origin <current-branch>
   ```

5. Display git's output message (e.g., "Everything up-to-date", push summary, or error).
6. On failure, surface Git error message.

---

### 6.3 mm sync

Shortcut for full synchronization:

```
mm sync
```

Default flow:

1. `mm sync pull`
2. Optionally (config or flag): `mm doctor --rebuild-index`
3. `mm sync push`

This is especially useful in `auto-commit` mode.

---

## 7. Automatic Actions

### 7.1 State-changing commands

Commands such as:

* `mm n`, `mm note`, `mm task`, `mm event`
* `mm mv`, `mm remove`
* `mm close`, `mm reopen`
* `mm edit`

### 7.2 auto-commit Mode Behavior

After command success:

1. Check Git repository state.
2. If there are changes:

   ```sh
   git add items tags workspace.json
   git commit -m "mm: <auto summary>"
   ```

3. If commit fails:
   Show warning but do not roll back filesystem changes.

No push or pull is performed.

---

### 7.3 auto-sync Mode Behavior

After the same commit procedure:

4. Attempt to push:

   ```sh
   git push origin <branch>
   ```

5. If push rejected:
   a. Try fast-forward pull:

      ```sh
      git pull --ff-only origin <branch>
      ```

   b. Retry push
   c. If still rejected:

      ```
      [mm] Auto-sync failed due to non-fast-forward update.
      Resolve manually and rerun mm sync.
      ```

Filesystem changes always remain applied; only the push fails.

---

## 8. Error Handling & Conflict Policy

### 8.1 Principles

* **Never auto-merge.**
* **Fast-forward only.**
* **mm operations never roll back file changes** even if Git fails.
* User is always able to drop to raw Git to resolve issues.

### 8.2 Conflict Cases

If `git pull --ff-only` fails:

```[mm] Non-fast-forward update detected.
Please resolve manually (git pull --rebase, edit, commit).
After resolving, run: mm sync```

### 8.3 Broken Index Case

If `.index/graph` becomes stale due to Git operations:

```mm doctor --rebuild-index```

This regenerates all index files from Frontmatter, ensuring a healthy graph.

---

## 9. Implementation Notes

### 9.1 Git Command Execution

mm invokes Git via subprocess:

* `git status --porcelain`
* `git add`
* `git commit`
* `git fetch`, `git pull --ff-only`, `git push`

A small abstraction layer (`GitClient` implementing `VersionControlService`) is recommended.

### 9.2 Workspace Root

All Git commands must run in:

```~/.mm/<workspace>/```

Never inside subdirectories.

### 9.3 Safety Checks

* Remote URL validation (basic format check)
* Fail if `origin` exists with different URL (use `--force` to overwrite)
* Validate branch name using `git check-ref-format --branch`
* Branch mismatch detection: Before push, verify current checked-out branch matches configured branch to prevent accidental data loss

---

## 10. Summary

* Git sync is controlled by two fields:

* `git.enabled` — turns sync on/off
* `git.sync_mode` — `"auto-commit"` or `"auto-sync"`
* `mm sync init` enables sync, configures repo, sets remote, generates `.gitignore`
* `auto-commit`: automatic commits only
* `auto-sync`: commits + pushes (with fast-forward only pulls)
* Sync commands:

* `mm sync pull`
* `mm sync push`
* `mm sync`
* Robustness ensured by:

* No automatic merges
* Manual conflict resolution
* Full `.index` rebuild via `mm doctor --rebuild-index`