## Story Log

### Goal
Implement a new sync mode ("lazy-sync") that batches synchronization to reduce command latency while maintaining automatic backup.

### Why
The current `auto-sync` mode causes a 1-2 second delay after every state-changing command due to the commit→pull→push sequence. While this ensures immediate synchronization, users who prioritize command responsiveness over real-time sync experience degraded UX. A middle-ground mode that commits locally (like `auto-commit`) but periodically syncs based on commit count or elapsed time would provide the best of both worlds.

### User Story
**As a mm user, I want a "lazy-sync" mode that automatically commits locally and periodically syncs to remote based on configurable thresholds, so that I get fast command execution while maintaining automatic backup without manual sync operations.**

### Acceptance Criteria

#### 1. Lazy-sync Mode Configuration
- [x] **Given** workspace.json, **When** I set `sync.mode` to `"lazy-sync"`, **Then** the mode is recognized and lazy-sync behavior is enabled.
- [x] **Given** `sync.mode="lazy-sync"`, **When** I configure `sync.lazy.commits` (e.g., 5), **Then** sync triggers after that many commits.
- [x] **Given** `sync.mode="lazy-sync"`, **When** I configure `sync.lazy.minutes` (e.g., 10), **Then** sync triggers after that many minutes since last sync.
- [x] **Given** both thresholds are configured, **When** either threshold is reached, **Then** sync is triggered (whichever comes first).

#### 2. Commit Behavior (Same as auto-commit)
- [x] **Given** `sync.mode="lazy-sync"`, **When** I run a state-changing command (note/task/event/mv/remove/close/reopen/snooze/edit/config set), **Then** a Git commit is created immediately (no push).
- [x] **Given** lazy-sync mode, **When** commit completes, **Then** command returns immediately without waiting for sync.

#### 3. Deferred Sync Trigger
- [x] **Given** `sync.lazy.commits=5` and 4 commits exist since last sync, **When** I run a state-changing command, **Then** commit is created and sync is triggered (5th commit).
- [x] **Given** `sync.lazy.minutes=10` and 10+ minutes have passed since last sync, **When** I run a state-changing command, **Then** commit is created and sync is triggered.
- [x] **Given** sync is triggered, **When** sync runs, **Then** it performs the full commit→pull(rebase)→push sequence.

#### 4. Loading Indicator (Pull/Push Operations)
- [x] **Given** `mm sync pull` runs, **When** pull is in progress, **Then** a loading indicator is displayed (e.g., "Pulling...").
- [x] **Given** `mm sync push` runs, **When** push is in progress, **Then** a loading indicator is displayed (e.g., "Pushing...").
- [x] **Given** `mm sync` or auto-sync/lazy-sync runs, **When** sync is in progress, **Then** a "Syncing..." indicator is shown.
- [x] **Given** operation completes successfully, **When** indicator is dismissed, **Then** no additional output is shown (silent on success).
- [x] **Given** operation fails, **When** indicator is dismissed, **Then** a warning message is displayed.

#### 5. State Tracking
- [x] **Given** lazy-sync mode, **When** sync completes, **Then** the commit count and last sync timestamp are reset/updated in `.state.json`.
- [x] **Given** `.state.json` tracks sync state, **When** mm starts, **Then** it reads the current commit count and last sync time.

#### 6. Default Configuration
- [x] **Given** `sync.mode="lazy-sync"` without explicit thresholds, **When** mm runs, **Then** reasonable defaults are used (commits=10, minutes=10).

#### 7. Error Handling
- [x] **Given** lazy-sync triggers sync but network fails, **When** sync completes, **Then** warning is displayed but commits remain, next threshold check will retry.
- [x] **Given** sync fails, **When** state is updated, **Then** commit count is NOT reset (sync will retry on next trigger).

### Out of Scope
- Background/async sync (sync still blocks when triggered, just less frequently)
- Sync scheduling daemon or timer-based triggers independent of commands
- Automatic conflict resolution
- Custom commit message templates
- Real-time progress percentage during sync

---

### Completed Work Summary

#### Implementation Completed

1. **Lazy-sync Mode Configuration**
   - Added `"lazy-sync"` as valid `sync.mode` in workspace schema
   - Added `sync.lazy.commits` (default: 10) and `sync.lazy.minutes` (default: 10) settings
   - Settings configurable via `mm config set sync.lazy.commits <n>` and `mm config set sync.lazy.minutes <n>`

2. **State Tracking in `.state.json`**
   - Added `SyncState` type with `commitsSinceLastSync` and `lastSyncTimestamp` fields
   - Implemented `StateRepository.loadSyncState()` and `StateRepository.saveSyncState()` methods
   - State persists across mm sessions

3. **AutoCommitWorkflow Enhancement**
   - Extended workflow to handle `lazy-sync` mode
   - Commits created immediately (like auto-commit)
   - Sync triggered when either threshold is met (OR condition)
   - On sync success: reset commit count and update timestamp
   - On sync failure: keep commit count for retry on next trigger

4. **Loading Indicator via Callback Pattern**
   - Added `onSync` callback to `AutoCommitInput` for loading indicator control
   - Loading indicator ("Syncing...") only shown when sync actually executes
   - CLI layer passes `withLoadingIndicator` wrapper via callback

5. **Manual Sync State Reset**
   - `mm sync` and `mm sync push` reset sync state after successful push
   - Ensures consistent behavior between manual and automatic sync

6. **Documentation Updates**
   - Updated README.md with lazy-sync mode description and config examples
   - Updated epic design document with lazy-sync field semantics and JSON schema

#### Files Modified
- `src/domain/models/workspace.ts` - LazySyncSettings type, DEFAULT_LAZY_SYNC_SETTINGS
- `src/domain/workflows/auto_commit.ts` - lazy-sync logic with onSync callback
- `src/domain/repositories/state_repository.ts` - SyncState type
- `src/infrastructure/fileSystem/state_repository.ts` - sync state persistence
- `src/presentation/cli/commands/config.ts` - sync.lazy.commits/minutes config keys
- `src/presentation/cli/commands/sync.ts` - resetSyncState after manual sync
- `src/presentation/cli/auto_commit_helper.ts` - onSync callback with loading indicator

#### Tests Added
- State repository sync state tests (4 tests)
- AutoCommitWorkflow lazy-sync tests (5 tests)

### Acceptance Checks

**Status: Accepted ✅**

Acceptance testing completed on 2026-01-01:
- All 19 acceptance criteria verified and passed
- Tested with local bare Git repository as remote
- Verified commit threshold trigger (5 commits)
- Verified time threshold trigger (1 minute)
- Verified loading indicators for all sync operations
- Verified error handling with invalid remote
- Verified state persistence across sessions

### Follow-ups / Open Risks

#### Addressed
- Time-based threshold requires tracking last sync timestamp in `.state.json` → Implemented via `lastSyncTimestamp` field
- Commit count tracking across mm sessions needs persistence → Implemented via `commitsSinceLastSync` field in `.state.json`
- Loading indicator UX design (spinner style, placement) → Using existing `withLoadingIndicator` utility with "Syncing..." message
- Configuration schema needs to be added to epic design document → Added `sync.lazy` settings to epic
- Consider whether thresholds should be AND (both must be met) vs OR (either triggers) → Implemented as OR (either triggers sync)

#### Remaining
- None identified
