## Story Log

### Goal
Implement a new sync mode ("lazy-sync") that batches synchronization to reduce command latency while maintaining automatic backup.

### Why
The current `auto-sync` mode causes a 1-2 second delay after every state-changing command due to the commit→pull→push sequence. While this ensures immediate synchronization, users who prioritize command responsiveness over real-time sync experience degraded UX. A middle-ground mode that commits locally (like `auto-commit`) but periodically syncs based on commit count or elapsed time would provide the best of both worlds.

### User Story
**As a mm user, I want a "lazy-sync" mode that automatically commits locally and periodically syncs to remote based on configurable thresholds, so that I get fast command execution while maintaining automatic backup without manual sync operations.**

### Acceptance Criteria

#### 1. Lazy-sync Mode Configuration
- [ ] **Given** workspace.json, **When** I set `sync.mode` to `"lazy-sync"`, **Then** the mode is recognized and lazy-sync behavior is enabled.
- [ ] **Given** `sync.mode="lazy-sync"`, **When** I configure `sync.lazy.commitThreshold` (e.g., 5), **Then** sync triggers after that many commits.
- [ ] **Given** `sync.mode="lazy-sync"`, **When** I configure `sync.lazy.timeThreshold` (e.g., 300 seconds), **Then** sync triggers after that much time since last sync.
- [ ] **Given** both thresholds are configured, **When** either threshold is reached, **Then** sync is triggered (whichever comes first).

#### 2. Commit Behavior (Same as auto-commit)
- [ ] **Given** `sync.mode="lazy-sync"`, **When** I run a state-changing command (note/task/event/mv/remove/close/reopen/snooze/edit/config set), **Then** a Git commit is created immediately (no push).
- [ ] **Given** lazy-sync mode, **When** commit completes, **Then** command returns immediately without waiting for sync.

#### 3. Deferred Sync Trigger
- [ ] **Given** `sync.lazy.commitThreshold=5` and 4 commits exist since last sync, **When** I run a state-changing command, **Then** commit is created and sync is triggered (5th commit).
- [ ] **Given** `sync.lazy.timeThreshold=300` and 300+ seconds have passed since last sync, **When** I run a state-changing command, **Then** commit is created and sync is triggered.
- [ ] **Given** sync is triggered, **When** sync runs, **Then** it performs the full commit→pull(rebase)→push sequence.

#### 4. Loading Indicator (Pull/Push Operations)
- [ ] **Given** `mm sync pull` runs, **When** pull is in progress, **Then** a loading indicator is displayed (e.g., "Pulling...").
- [ ] **Given** `mm sync push` runs, **When** push is in progress, **Then** a loading indicator is displayed (e.g., "Pushing...").
- [ ] **Given** `mm sync` or auto-sync/lazy-sync runs, **When** sync is in progress, **Then** pull indicator is shown first, then push indicator.
- [ ] **Given** operation completes successfully, **When** indicator is dismissed, **Then** no additional output is shown (silent on success).
- [ ] **Given** operation fails, **When** indicator is dismissed, **Then** a warning message is displayed.

#### 5. State Tracking
- [ ] **Given** lazy-sync mode, **When** sync completes, **Then** the commit count and last sync timestamp are reset/updated in `.state.json`.
- [ ] **Given** `.state.json` tracks sync state, **When** mm starts, **Then** it reads the current commit count and last sync time.

#### 6. Default Configuration
- [ ] **Given** `sync.mode="lazy-sync"` without explicit thresholds, **When** mm runs, **Then** reasonable defaults are used (e.g., commitThreshold=10, timeThreshold=600).

#### 7. Error Handling
- [ ] **Given** lazy-sync triggers sync but network fails, **When** sync completes, **Then** warning is displayed but commits remain, next threshold check will retry.
- [ ] **Given** sync fails, **When** state is updated, **Then** commit count is NOT reset (sync will retry on next trigger).

### Out of Scope
- Background/async sync (sync still blocks when triggered, just less frequently)
- Sync scheduling daemon or timer-based triggers independent of commands
- Automatic conflict resolution
- Custom commit message templates
- Real-time progress percentage during sync

---

### Completed Work Summary
Not yet started.

### Acceptance Checks

**Status: Pending Product Owner Review**

Developer verification completed:
- [List what the developer manually verified]
- [Note any observations or findings]

**Awaiting product owner acceptance testing before marking this user story as complete.**

### Follow-ups / Open Risks

#### Addressed
- (none yet)

#### Remaining
- Time-based threshold requires tracking last sync timestamp in `.state.json`
- Commit count tracking across mm sessions needs persistence
- Loading indicator UX design (spinner style, placement)
- Configuration schema needs to be added to epic design document
- Consider whether thresholds should be AND (both must be met) vs OR (either triggers) - current design is OR
